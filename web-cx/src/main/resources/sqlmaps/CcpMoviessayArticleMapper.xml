<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sun3d.why.dao.ccp.CcpMoviessayArticleMapper" >
  <resultMap id="BaseResultMap" type="com.culturecloud.model.bean.moviessay.CcpMoviessayArticle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 02 17:15:31 CST 2017.
    -->
    <id column="article_id" property="articleId" jdbcType="VARCHAR" />
    <result column="user_id" property="userId" jdbcType="VARCHAR" />
    <result column="movie_name" property="movieName" jdbcType="VARCHAR" />
    <result column="article_type" property="articleType" jdbcType="INTEGER" />
    <result column="theme_type" property="themeType" jdbcType="INTEGER" />
    <result column="article_is_del" property="articleIsDel" jdbcType="INTEGER" />
    <result column="article_title" property="articleTitle" jdbcType="VARCHAR" />
    <result column="article_create_time" property="articleCreateTime" jdbcType="TIMESTAMP" />
    <result column="article_like" property="articleLike" jdbcType="INTEGER" />
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="com.culturecloud.model.bean.moviessay.CcpMoviessayArticle" extends="BaseResultMap" >
    <result column="article_text" property="articleText" jdbcType="LONGVARCHAR" />
  </resultMap> 
  <resultMap type="com.sun3d.why.dao.ccp.CcpMoviessayArticleDto" id="BaseResultDtoMap" extends="ResultMapWithBLOBs">
  </resultMap>
 
 
  <sql id="Base_Column_List" >
    article_id, user_id, movie_name,article_type, theme_type, article_is_del, article_title, article_create_time, 
    article_like
  </sql>
  <sql id="Blob_Column_List" >
    article_text
  </sql>
  <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.String" >
   
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from ccp_moviessay_article
    where article_id = #{articleId,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
   
    delete from ccp_moviessay_article
    where article_id = #{articleId,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.culturecloud.model.bean.moviessay.CcpMoviessayArticle" >
    
    insert into ccp_moviessay_article (article_id, user_id, article_type, movie_name,
      theme_type, article_is_del, article_title, 
      article_create_time, article_like, article_text
      )
    values (#{articleId,jdbcType=VARCHAR}, #{userId,jdbcType=VARCHAR}, #{articleType,jdbcType=INTEGER}, 
      #{movieName,jdbcType=VARCHAR},#{themeType,jdbcType=INTEGER}, #{articleIsDel,jdbcType=INTEGER},
      #{articleTitle,jdbcType=VARCHAR}, #{articleCreateTime,jdbcType=TIMESTAMP}, #{articleLike,jdbcType=INTEGER},
      #{articleText,jdbcType=LONGVARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.culturecloud.model.bean.moviessay.CcpMoviessayArticle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 02 17:15:31 CST 2017.
    -->
    insert into ccp_moviessay_article
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="articleId != null" >
        article_id,
      </if>
      <if test="userId != null" >
        user_id,
      </if>
      <if test="articleType != null" >
        article_type,
      </if>
      <if test="themeType != null" >
        theme_type,
      </if>
      <if test="articleIsDel != null" >
        article_is_del,
      </if>
      <if test="articleTitle != null" >
        article_title,
      </if>
      <if test="articleCreateTime != null" >
        article_create_time,
      </if>
      <if test="articleLike != null" >
        article_like,
      </if>
      <if test="articleText != null" >
        article_text,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="articleId != null" >
        #{articleId,jdbcType=VARCHAR},
      </if>
      <if test="userId != null" >
        #{userId,jdbcType=VARCHAR},
      </if>
      <if test="articleType != null" >
        #{articleType,jdbcType=INTEGER},
      </if>
      <if test="themeType != null" >
        #{themeType,jdbcType=INTEGER},
      </if>
      <if test="articleIsDel != null" >
        #{articleIsDel,jdbcType=INTEGER},
      </if>
      <if test="articleTitle != null" >
        #{articleTitle,jdbcType=VARCHAR},
      </if>
      <if test="articleCreateTime != null" >
        #{articleCreateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="articleLike != null" >
        #{articleLike,jdbcType=INTEGER},
      </if>
      <if test="articleText != null" >
        #{articleText,jdbcType=LONGVARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.culturecloud.model.bean.moviessay.CcpMoviessayArticle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 02 17:15:31 CST 2017.
    -->
    update ccp_moviessay_article
    <set >
      <if test="userId != null" >
        user_id = #{userId,jdbcType=VARCHAR},
      </if>
      <if test="articleType != null" >
        article_type = #{articleType,jdbcType=INTEGER},
      </if>
      <if test="themeType != null" >
        theme_type = #{themeType,jdbcType=INTEGER},
      </if>
      <if test="articleIsDel != null" >
        article_is_del = #{articleIsDel,jdbcType=INTEGER},
      </if>
      <if test="articleTitle != null" >
        article_title = #{articleTitle,jdbcType=VARCHAR},
      </if>
      <if test="articleCreateTime != null" >
        article_create_time = #{articleCreateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="articleLike != null" >
        article_like = #{articleLike,jdbcType=INTEGER},
      </if>
      <if test="articleText != null" >
        article_text = #{articleText,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where article_id = #{articleId,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.culturecloud.model.bean.moviessay.CcpMoviessayArticle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 02 17:15:31 CST 2017.
    -->
    update ccp_moviessay_article
    set user_id = #{userId,jdbcType=VARCHAR},
      article_type = #{articleType,jdbcType=INTEGER},
      theme_type = #{themeType,jdbcType=INTEGER},
      article_is_del = #{articleIsDel,jdbcType=INTEGER},
      article_title = #{articleTitle,jdbcType=VARCHAR},
      article_create_time = #{articleCreateTime,jdbcType=TIMESTAMP},
      article_like = #{articleLike,jdbcType=INTEGER},
      article_text = #{articleText,jdbcType=LONGVARCHAR}
    where article_id = #{articleId,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.culturecloud.model.bean.moviessay.CcpMoviessayArticle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 02 17:15:31 CST 2017.
    -->
    update ccp_moviessay_article
    set user_id = #{userId,jdbcType=VARCHAR},
      article_type = #{articleType,jdbcType=INTEGER},
      theme_type = #{themeType,jdbcType=INTEGER},
      article_is_del = #{articleIsDel,jdbcType=INTEGER},
      article_title = #{articleTitle,jdbcType=VARCHAR},
      article_create_time = #{articleCreateTime,jdbcType=TIMESTAMP},
      article_like = #{articleLike,jdbcType=INTEGER}
    where article_id = #{articleId,jdbcType=VARCHAR}
  </update>
  
  
  
  
  	<!-- 获取到文章的总记录数 -->
    <select id="queryMoviessayArticleListCount" resultType="java.lang.Integer" parameterType="java.util.Map"> 
	    select 
			count(*)
			from ccp_moviessay_article
			where 1 = 1
			<if test="articleType != null">
				and article_type = #{articleType}
			</if>
			<if test="themeType != null">
				and theme_type = #{themeType}
			</if>
			<if test="userId != null">
				and user_id = #{userId}
			</if>
			<if test="movieName!=null">
				and movie_name = #{movieName}
			</if>
			and article_is_del = 0
	  </select>
  
  
  
  
  <!-- 查找文章按类显示出来 /包括个人部分-->
  <select id="queryMoviessayArticleList" resultMap="BaseResultDtoMap" parameterType="java.util.Map">
  
	  select a.*
	   <if test="loginUser != null">
	   	,IF((SELECT COUNT(l.article_id) FROM ccp_moviessay_like l WHERE l.article_id = a.article_id and l.user_id=#{loginUser} and l.create_date = CURRENT_DATE)>0,1,0) as isLike
	   </if>
	  	,u.USER_NAME AS userName
		,u.USER_HEAD_IMG_URL AS userHeadImgUrl
	    from ccp_moviessay_article a
	    left join cms_terminal_user u on u.user_id = a.user_id
	    where 1 = 1
	    <if test="articleType != null">
	    	and article_type = #{articleType}
	    </if>
	    <if test="userId != null">
	    	and a.user_id = #{userId}
	    </if>
	    <if test="themeType != null">
	    	and a.theme_type = #{themeType}
	    </if>
	    and article_is_del = 0
	    ORDER BY a.article_create_time DESC
		limit #{firstResult},#{rows}
	    
	  </select>
  
  
  
  
  	<!-- 查询文章的详情 -->
    <select id="queryMoviessayArticleDetail" resultMap="BaseResultDtoMap">
  
	   select a.*
	   <if test="loginUser != null">
	   		,IF((SELECT COUNT(l.article_id) FROM ccp_moviessay_like l WHERE l.article_id = a.article_id and l.user_id=#{loginUser} and l.create_date = CURRENT_DATE)>0,1,0) as isLike
	   </if>
	  	,u.USER_NAME AS userName
		,u.USER_HEAD_IMG_URL AS userHeadImgUrl
	    from ccp_moviessay_article a
	    left join cms_terminal_user u on u.user_id = a.user_id
	    where article_id =#{articleId}
    </select>
  
  
  
  
  
  	<!-- 微评的排名查询 -->
  	 <select id="queryMoviessayArticleRanking" resultMap="BaseResultDtoMap" parameterType="java.util.Map" >
  
		<!-- SELECT @rowno := @rowno + 1 AS rowno ,a.* FROM (
		 SELECT a.* 
		 <if test="userId != null">
			,IF((SELECT COUNT(l.article_id) FROM ccp_moviessay_like l WHERE l.article_id = a.article_id and l.user_id=#{userId} and l.create_date = CURRENT_DATE)>0,1,0) as isLike
		</if>
		 ,u.USER_NAME AS userName
		 ,u.USER_HEAD_IMG_URL AS userHeadImgUrl
		 FROM(
			SELECT a.* FROM 
			ccp_moviessay_article a 
			WHERE 1=1 
			AND a.article_is_del = 0 
			AND a.article_type = 1 
			ORDER BY a.article_like DESC
		 ) a LEFT JOIN cms_terminal_user u ON u.user_id = a.user_id	
		LIMIT 10 ) a,(SELECT @rowno := 0) t
		 -->
		
		SELECT
			@rowno := @rowno + 1 AS rowno,
			a.*
		FROM
			(
				SELECT
					a.article_id,
					a.user_id,
					a.movie_name,
					a.article_type,
					a.article_is_del,
					a.article_title,
					a.article_text,
					a.article_create_time,
					a.article_like,
					u.USER_NAME AS userName
					<if test="userId != null">
						,IF((SELECT COUNT(l.article_id) FROM ccp_moviessay_like l WHERE l.article_id = a.article_id and l.user_id=#{userId} and l.create_date = CURRENT_DATE) > 0,1,0) as isLike
					</if>
					,u.USER_HEAD_IMG_URL AS userHeadImgUrl
				FROM
					(
						SELECT
							article_id,
							user_id,
							movie_name,
							article_type,
							theme_type,
							article_is_del,
							article_title,
							article_text,
							article_create_time,
							MAX(article_like) article_like
						FROM
							ccp_moviessay_article
						WHERE
							1 = 1
						AND article_is_del = 0
						AND article_type = 1
						GROUP BY
							user_id
						ORDER BY
							article_like DESC,
							article_create_time
					) a
				LEFT JOIN cms_terminal_user u ON u.user_id = a.user_id
				LIMIT 10
			) a,
			(SELECT @rowno := 0) t
	  </select>
  
  
  
  		<!-- 查询个人的 文章发布内容-->
  		<select id="myMoviessayArticleBest" resultMap="BaseResultDtoMap" parameterType="java.lang.String" >
 
		 SELECT
				a.*,
			IF (
				(
					SELECT
						COUNT(l.article_id)
					FROM
						ccp_moviessay_like l
					WHERE
						l.article_id = a.article_id
					AND l.user_id = a.user_id
					AND l.create_date = CURRENT_DATE
				) &gt; 0,
				1,
				0
			) AS isLike
			FROM
				(
					SELECT
						t2.*, MIN(rowno)
					FROM
						(
							SELECT
								@rowno := @rowno + 1 AS rowno,
								a.*
							FROM
								(
									SELECT
										a.*, u.USER_NAME AS userName,
										u.USER_HEAD_IMG_URL AS userHeadImgUrl
									FROM
										(
											SELECT
												a.*
											FROM
												ccp_moviessay_article a
											WHERE
												1 = 1
											AND a.article_is_del = 0
											AND a.article_type = 1
											ORDER BY
												a.article_like DESC,
												article_create_time
										) a
									LEFT JOIN cms_terminal_user u ON u.user_id = a.user_id
								) a,
								(SELECT @rowno := 0) t
						) t2
					WHERE
						user_id = #{userId}
				) a
		  </select>
</mapper>